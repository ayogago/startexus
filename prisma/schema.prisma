generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id                String   @id @default(cuid())
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  role              String   @default("BUYER")
  email             String   @unique
  emailVerified     DateTime?
  password          String?
  name              String?
  handle            String?  @unique
  bio               String?
  avatarUrl         String?
  company           String?
  location          String?
  website           String?
  verified          Boolean  @default(false)
  disabled          Boolean  @default(false)
  failedLoginAttempts Int    @default(0)
  lockedUntil       DateTime?
  lastLoginAt       DateTime?
  lastLoginIp       String?
  accounts          Account[]
  sessions          Session[]
  listings          Listing[]
  messages          Message[] @relation("UserMessages")
  threads           ThreadParticipant[]
  savedListings     SavedListing[]
  reports           Report[]
  blogPosts         BlogPost[]
  blogComments      BlogComment[]
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Listing {
  id                String   @id @default(cuid())
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  status            String   @default("DRAFT")
  sellerId          String
  seller            User     @relation(fields: [sellerId], references: [id])
  title             String
  slug              String   @unique
  businessType      String
  category          String
  isAiRelated       Boolean  @default(false)
  aiTechnologies    String   @default("[]")
  askingPrice       Int?
  priceType         String   @default("ASKING")
  revenueTtm        Int?
  profitTtm         Int?
  mrr               Int?
  aov               Int?
  trafficTtm        Int?
  monetization      String   @default("[]")
  platform          String   @default("[]")
  techStack         String   @default("[]")
  establishedAt     DateTime?
  workloadHrsPerWk  Int?
  teamSize          Int?
  description       String
  highlights        String   @default("[]")
  growthOps         String   @default("[]")
  risks             String   @default("[]")
  assetsIncluded    String   @default("[]")
  reasonForSale     String?
  images            ListingImage[]
  location          String?
  confidential      Boolean  @default(false)
  siteUrl           String?
  analyticsProofUrl String?
  revenueProofUrl   String?
  ndaRequired       Boolean  @default(false)
  views             Int      @default(0)
  favorites         Int      @default(0)
  publishedAt       DateTime?
  flagged           Boolean  @default(false)
  featured          Boolean  @default(false)
  featuredAt        DateTime?
  rejectionReason   String?
  savedListings     SavedListing[]
  threads           Thread[]
}

model ListingImage {
  id        String   @id @default(cuid())
  listingId String
  listing   Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
  url       String
  alt       String?
  order     Int      @default(0)
}

model SavedListing {
  id        String   @id @default(cuid())
  userId    String
  listingId String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  listing   Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@unique([userId, listingId])
}

model Thread {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  listingId String
  listing   Listing  @relation(fields: [listingId], references: [id])
  participants ThreadParticipant[]
  messages   Message[]
  lastMessageAt DateTime @default(now())
}

model ThreadParticipant {
  id       String @id @default(cuid())
  threadId String
  userId   String
  roleInThread String
  thread   Thread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([threadId, userId])
}

model Message {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  threadId    String
  senderId    String
  body        String
  readBy      String   @default("[]")
  sender      User     @relation("UserMessages", fields: [senderId], references: [id])
  thread      Thread   @relation(fields: [threadId], references: [id], onDelete: Cascade)
  flagged     Boolean  @default(false)
}

model Report {
  id         String   @id @default(cuid())
  createdAt  DateTime @default(now())
  reporterId String
  targetType String
  targetId   String
  reason     String
  status     String   @default("OPEN")
  reporter   User     @relation(fields: [reporterId], references: [id])
}

model ValuationRequest {
  id                   String   @id @default(cuid())
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  businessName        String
  businessType        String
  websiteUrl          String
  monthlyRevenue      String
  yearlyRevenue       String?
  profitMargin        String?
  monthsEstablished   String
  primaryTrafficSource String?
  isAiRelated         Boolean?
  sellTimeframe       String?
  contactName         String
  contactEmail        String
  contactPhone        String?
  additionalInfo      String?
  status              String   @default("PENDING")
  requestedAt         DateTime @default(now())
  completedAt         DateTime?
  assignedTo          String?
  notes               String?
}

model BlogPost {
  id               String   @id @default(cuid())
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  title            String
  slug             String   @unique
  excerpt          String?
  content          String
  featuredImage    String?
  tags             String   @default("[]")
  categories       String   @default("[]")
  status           String   @default("DRAFT")
  publishedAt      DateTime?
  metaTitle        String?
  metaDescription  String?
  authorId         String
  author           User     @relation(fields: [authorId], references: [id])
  views            Int      @default(0)
  featured         Boolean  @default(false)
  comments         BlogComment[]
}

model BlogComment {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  content   String
  authorId  String?
  author    User?    @relation(fields: [authorId], references: [id])
  postId    String
  post      BlogPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  parentId  String?
  parent    BlogComment? @relation("CommentReplies", fields: [parentId], references: [id])
  replies   BlogComment[] @relation("CommentReplies")
  status    String   @default("APPROVED")
}

model NewsletterSubscriber {
  id            String   @id @default(cuid())
  email         String   @unique
  name          String?
  subscribedAt  DateTime @default(now())
  status        String   @default("ACTIVE")
  unsubscribeToken String @unique @default(cuid())
  emailsSent    NewsletterEmail[]
}

model NewsletterEmail {
  id            String   @id @default(cuid())
  subscriberId  String
  subscriber    NewsletterSubscriber @relation(fields: [subscriberId], references: [id], onDelete: Cascade)
  blogPostId    String?
  subject       String
  sentAt        DateTime @default(now())
  openedAt      DateTime?
  clickedAt     DateTime?
  clickedLinks  String   @default("[]")
}
