generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id                String   @id @default(cuid())
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  role              String   @default("BUYER")
  email             String   @unique
  emailVerified     DateTime?
  password          String?
  name              String?
  handle            String?  @unique
  bio               String?
  avatarUrl         String?
  company           String?
  location          String?
  website           String?
  verified          Boolean  @default(false)
  disabled          Boolean  @default(false)
  failedLoginAttempts Int    @default(0)
  lockedUntil       DateTime?
  lastLoginAt       DateTime?
  lastLoginIp       String?
  accounts          Account[]
  sessions          Session[]
  listings          Listing[]
  messages          Message[] @relation("UserMessages")
  threads           ThreadParticipant[]
  savedListings     SavedListing[]
  reports           Report[]
  blogPosts         BlogPost[]
  blogComments      BlogComment[]
  notifications     Notification[]
  reviewsGiven      Review[]       @relation("ReviewAuthor")
  reviewsReceived   Review[]       @relation("ReviewTarget")
  savedSearches     SavedSearch[]
  dealsAsBuyer      Deal[]         @relation("DealBuyer")
  dealsAsSeller     Deal[]         @relation("DealSeller")
  documents         DealDocument[] @relation("DocumentUploader")
  scheduledCalls    ScheduledCall[] @relation("CallScheduler")
  scheduledCallsReceived ScheduledCall[] @relation("CallReceiver")
  verificationRequests   UserVerification[]
  auditLogs         AuditLog[]
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Listing {
  id                String   @id @default(cuid())
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  status            String   @default("DRAFT")
  sellerId          String
  seller            User     @relation(fields: [sellerId], references: [id])
  title             String
  slug              String   @unique
  businessType      String
  category          String
  isAiRelated       Boolean  @default(false)
  aiTechnologies    String   @default("[]")
  askingPrice       Int?
  priceType         String   @default("ASKING")
  revenueTtm        Int?
  profitTtm         Int?
  mrr               Int?
  aov               Int?
  trafficTtm        Int?
  monetization      String   @default("[]")
  platform          String   @default("[]")
  techStack         String   @default("[]")
  establishedAt     DateTime?
  workloadHrsPerWk  Int?
  teamSize          Int?
  description       String
  highlights        String   @default("[]")
  growthOps         String   @default("[]")
  risks             String   @default("[]")
  assetsIncluded    String   @default("[]")
  reasonForSale     String?
  images            ListingImage[]
  location          String?
  confidential      Boolean  @default(false)
  siteUrl           String?
  analyticsProofUrl String?
  revenueProofUrl   String?
  ndaRequired       Boolean  @default(false)
  views             Int      @default(0)
  favorites         Int      @default(0)
  publishedAt       DateTime?
  flagged           Boolean  @default(false)
  featured          Boolean  @default(false)
  featuredAt        DateTime?
  rejectionReason   String?
  savedListings     SavedListing[]
  threads           Thread[]
  reviews           Review[]
  deals             Deal[]
  viewEvents        ViewEvent[]
}

model ListingImage {
  id        String   @id @default(cuid())
  listingId String
  listing   Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
  url       String
  alt       String?
  order     Int      @default(0)
}

model SavedListing {
  id        String   @id @default(cuid())
  userId    String
  listingId String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  listing   Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@unique([userId, listingId])
}

model Thread {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  listingId String
  listing   Listing  @relation(fields: [listingId], references: [id])
  participants ThreadParticipant[]
  messages   Message[]
  lastMessageAt DateTime @default(now())
}

model ThreadParticipant {
  id       String @id @default(cuid())
  threadId String
  userId   String
  roleInThread String
  thread   Thread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([threadId, userId])
}

model Message {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  threadId    String
  senderId    String
  body        String
  readBy      String   @default("[]")
  sender      User     @relation("UserMessages", fields: [senderId], references: [id])
  thread      Thread   @relation(fields: [threadId], references: [id], onDelete: Cascade)
  flagged     Boolean  @default(false)
}

model Report {
  id         String   @id @default(cuid())
  createdAt  DateTime @default(now())
  reporterId String
  targetType String
  targetId   String
  reason     String
  status     String   @default("OPEN")
  reporter   User     @relation(fields: [reporterId], references: [id])
}

model ValuationRequest {
  id                   String   @id @default(cuid())
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  businessName        String
  businessType        String
  websiteUrl          String
  monthlyRevenue      String
  yearlyRevenue       String?
  profitMargin        String?
  monthsEstablished   String
  primaryTrafficSource String?
  isAiRelated         Boolean?
  sellTimeframe       String?
  contactName         String
  contactEmail        String
  contactPhone        String?
  additionalInfo      String?
  status              String   @default("PENDING")
  requestedAt         DateTime @default(now())
  completedAt         DateTime?
  assignedTo          String?
  notes               String?
}

model BlogPost {
  id               String   @id @default(cuid())
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  title            String
  slug             String   @unique
  excerpt          String?
  content          String
  featuredImage    String?
  tags             String   @default("[]")
  categories       String   @default("[]")
  status           String   @default("DRAFT")
  publishedAt      DateTime?
  metaTitle        String?
  metaDescription  String?
  authorId         String
  author           User     @relation(fields: [authorId], references: [id])
  views            Int      @default(0)
  featured         Boolean  @default(false)
  comments         BlogComment[]
}

model BlogComment {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  content   String
  authorId  String?
  author    User?    @relation(fields: [authorId], references: [id])
  postId    String
  post      BlogPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  parentId  String?
  parent    BlogComment? @relation("CommentReplies", fields: [parentId], references: [id])
  replies   BlogComment[] @relation("CommentReplies")
  status    String   @default("APPROVED")
}

model NewsletterSubscriber {
  id            String   @id @default(cuid())
  email         String   @unique
  name          String?
  subscribedAt  DateTime @default(now())
  status        String   @default("ACTIVE")
  unsubscribeToken String @unique @default(cuid())
  emailsSent    NewsletterEmail[]
}

model NewsletterEmail {
  id            String   @id @default(cuid())
  subscriberId  String
  subscriber    NewsletterSubscriber @relation(fields: [subscriberId], references: [id], onDelete: Cascade)
  blogPostId    String?
  subject       String
  sentAt        DateTime @default(now())
  openedAt      DateTime?
  clickedAt     DateTime?
  clickedLinks  String   @default("[]")
}

// ========== NEW FEATURE MODELS ==========

model Notification {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String   // MESSAGE, LISTING_APPROVED, LISTING_REJECTED, DEAL_UPDATE, REVIEW, SAVED_ALERT, VERIFICATION
  title     String
  message   String
  link      String?
  read      Boolean  @default(false)
  data      String   @default("{}") // JSON metadata

  @@index([userId, read])
  @@index([userId, createdAt])
}

model Review {
  id         String   @id @default(cuid())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  authorId   String
  author     User     @relation("ReviewAuthor", fields: [authorId], references: [id])
  targetId   String
  target     User     @relation("ReviewTarget", fields: [targetId], references: [id])
  listingId  String?
  listing    Listing? @relation(fields: [listingId], references: [id])
  dealId     String?
  deal       Deal?    @relation(fields: [dealId], references: [id])
  rating     Int      // 1-5
  title      String
  content    String
  response   String?  // Seller can respond
  respondedAt DateTime?
  status     String   @default("PUBLISHED") // PUBLISHED, HIDDEN, FLAGGED

  @@unique([authorId, dealId])
  @@index([targetId])
}

model SavedSearch {
  id         String   @id @default(cuid())
  createdAt  DateTime @default(now())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name       String
  filters    String   @default("{}") // JSON: {type, minPrice, maxPrice, minMRR, etc.}
  emailAlert Boolean  @default(true)
  lastNotifiedAt DateTime?

  @@index([userId])
}

model Deal {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  listingId   String
  listing     Listing  @relation(fields: [listingId], references: [id])
  buyerId     String
  buyer       User     @relation("DealBuyer", fields: [buyerId], references: [id])
  sellerId    String
  seller      User     @relation("DealSeller", fields: [sellerId], references: [id])
  stage       String   @default("INQUIRY") // INQUIRY, OFFER, NEGOTIATION, DUE_DILIGENCE, CLOSING, COMPLETED, CANCELLED
  offerAmount Int?
  notes       String?
  threadId    String?
  documents   DealDocument[]
  reviews     Review[]
  calls       ScheduledCall[]
  timeline    DealEvent[]

  @@index([buyerId])
  @@index([sellerId])
  @@index([listingId])
}

model DealEvent {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  dealId    String
  deal      Deal     @relation(fields: [dealId], references: [id], onDelete: Cascade)
  type      String   // STAGE_CHANGE, NOTE, DOCUMENT_ADDED, OFFER_MADE, CALL_SCHEDULED
  title     String
  details   String?
  actorId   String?
}

model DealDocument {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  dealId      String
  deal        Deal     @relation(fields: [dealId], references: [id], onDelete: Cascade)
  uploaderId  String
  uploader    User     @relation("DocumentUploader", fields: [uploaderId], references: [id])
  name        String
  fileUrl     String
  fileType    String
  fileSize    Int
  category    String   @default("OTHER") // FINANCIALS, LEGAL, ANALYTICS, CONTRACTS, OTHER
  description String?

  @@index([dealId])
}

model ScheduledCall {
  id           String   @id @default(cuid())
  createdAt    DateTime @default(now())
  schedulerId  String
  scheduler    User     @relation("CallScheduler", fields: [schedulerId], references: [id])
  receiverId   String
  receiver     User     @relation("CallReceiver", fields: [receiverId], references: [id])
  dealId       String?
  deal         Deal?    @relation(fields: [dealId], references: [id])
  scheduledAt  DateTime
  duration     Int      @default(30) // minutes
  title        String
  notes        String?
  meetingLink  String?
  status       String   @default("PENDING") // PENDING, CONFIRMED, COMPLETED, CANCELLED

  @@index([schedulerId])
  @@index([receiverId])
}

model UserVerification {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type        String   // IDENTITY, BUSINESS, FUNDS
  status      String   @default("PENDING") // PENDING, APPROVED, REJECTED
  documentUrl String?
  notes       String?
  reviewedBy  String?
  reviewedAt  DateTime?

  @@index([userId])
}

model ViewEvent {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  listingId String
  listing   Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
  visitorIp String?
  referrer  String?

  @@index([listingId, createdAt])
}

model AuditLog {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  action    String   // LISTING_APPROVED, LISTING_REJECTED, USER_DISABLED, USER_VERIFIED, etc.
  targetType String  // LISTING, USER, REPORT, etc.
  targetId  String
  details   String?
  ipAddress String?

  @@index([userId])
  @@index([targetType, targetId])
}
